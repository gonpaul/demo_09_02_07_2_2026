{% extends 'base.html' %}

{% block title %}Товары{% endblock %}

{% block content %}
{% if not user_fio %}
    <p><a href="{% url 'login' %}">← Вернуться к авторизации</a></p>
{% endif %}

<h2>Каталог товаров</h2>

{% if can_filter %}
<form method="get" id="filter-form" style="margin-bottom: 20px;">
    <input type="text" name="search" id="search-input"
           value="{{ search_query }}" placeholder="Поиск...">

    <select name="supplier" id="supplier-select">
        <option value="">Все поставщики</option>
        {% for sup in suppliers %}
            <option value="{{ sup.id }}"
                {% if selected_supplier == sup.id|stringformat:"i" %}selected{% endif %}>
                {{ sup.name }}
            </option>
        {% endfor %}
    </select>

    <select name="sort" id="sort-select">
        <option value="">Сортировка</option>
        <option value="stock_qty" {% if sort_by == 'stock_qty' %}selected{% endif %}>
            Количество ↑
        </option>
        <option value="-stock_qty" {% if sort_by == '-stock_qty' %}selected{% endif %}>
            Количество ↓
        </option>
    </select>

    <a href="{% url 'products' %}">Сбросить</a>
</form>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('filter-form');
    if (!form) return;

    var searchInput = document.getElementById('search-input');
    var supplierSelect = document.getElementById('supplier-select');
    var sortSelect = document.getElementById('sort-select');
    var tableBody = document.getElementById('products-body');
    var debounceTimer;

    function updateTable() {
        var params = new URLSearchParams(new FormData(form));
        fetch('{% url "products" %}?' + params.toString(), {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(response) { return response.text(); })
        .then(function(html) {
            tableBody.innerHTML = html;
        });
    }

    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(updateTable, 300);
    });

    supplierSelect.addEventListener('change', updateTable);
    sortSelect.addEventListener('change', updateTable);
});
</script>

<table>
    <thead>
        <tr>
            <th>Фото</th>
            <th>Название</th>
            <th>Категория</th>
            <th>Производитель</th>
            <th>Поставщик</th>
            <th>Цена</th>
            <th>Остаток</th>
        </tr>
    </thead>
    <tbody id="products-body">
        {% include 'products_table.html' %}
    </tbody>
</table>
{% endblock %}
